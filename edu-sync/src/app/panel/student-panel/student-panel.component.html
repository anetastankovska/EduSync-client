<div class="page-center">
  <mat-card class="panel">
    <h2>Student Panel</h2>

    <!-- DETAILS -->
    <section class="details-wrap">
      <h3 class="section-title">My Details</h3>

      <form
        [formGroup]="detailForm"
        (ngSubmit)="saveDetails()"
        class="details-form"
      >
        <mat-form-field appearance="outline" class="field col-6">
          <mat-label>Name</mat-label>
          <input matInput formControlName="name" />
        </mat-form-field>

        <mat-form-field appearance="outline" class="field col-6">
          <mat-label>Address</mat-label>
          <input matInput formControlName="address" />
        </mat-form-field>

        <mat-form-field appearance="outline" class="field col-4">
          <mat-label>Telephone</mat-label>
          <input matInput type="tel" formControlName="telephone" />
        </mat-form-field>

        <mat-form-field appearance="outline" class="field col-4">
          <mat-label>Date of birth</mat-label>
          <input matInput [matDatepicker]="dp" formControlName="dateOfBirth" />
          <mat-datepicker-toggle matSuffix [for]="dp"></mat-datepicker-toggle>
          <mat-datepicker #dp></mat-datepicker>
        </mat-form-field>

        <div class="actions col-12">
          <button
            mat-flat-button
            color="primary"
            type="submit"
            [disabled]="saving() || loading()"
          >
            {{ saving() ? "Saving…" : "Save details" }}
          </button>
        </div>
      </form>
    </section>

    <mat-divider class="sep"></mat-divider>

    <!-- ACADEMY & SUBJECTS -->
    <section class="section">
      <h3>My Academy</h3>

      <div *ngIf="academy; else noAcad" class="academy">
        <div class="row">
          <div>
            <strong>{{ academy.name }}</strong>
          </div>
          <div>{{ academy.description }}</div>
          <div>Start: {{ academy.startDate | date }}</div>
          <div>End: {{ academy.endDate | date }}</div>
          <div>Price: {{ academy.price | currency }}</div>
        </div>

        <h4>Subjects</h4>
        <mat-list>
          <mat-list-item *ngFor="let s of subjects">
            <div matListItemTitle>{{ s.name }}</div>
            <div matListItemLine>
              {{ s.numberOfClasses }} classes — {{ s.difficulty }}
            </div>
          </mat-list-item>
        </mat-list>
      </div>

      <ng-template #noAcad>
        <p>No academy assigned.</p>
      </ng-template>
    </section>

    <mat-divider class="sep"></mat-divider>

    <!-- REVIEW A TRAINER -->
    <section class="section">
      <h3>Rate a Trainer</h3>

      <form [formGroup]="reviewForm" (ngSubmit)="submitReview()" class="form">
        <mat-form-field appearance="outline" class="col-6">
          <mat-label>Subject</mat-label>
          <mat-select formControlName="subjectId" required>
            <mat-option *ngFor="let s of subjects" [value]="s.id">{{
              s.name
            }}</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="col-6">
          <mat-label>Trainer</mat-label>
          <!-- disabled state controlled by FormControl; no [disabled] binding -->
          <mat-select formControlName="trainerId">
            <mat-option *ngIf="trainerLoading()" [disabled]="true"
              >Loading…</mat-option
            >

            <ng-container *ngIf="!trainerLoading()">
              <mat-option *ngFor="let t of trainers" [value]="t.id">{{
                t.name
              }}</mat-option>
              <mat-option *ngIf="!trainers?.length" [disabled]="true">
                No trainers for this subject.
              </mat-option>
            </ng-container>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="col-3">
          <mat-label>Grade (1–5)</mat-label>
          <input
            matInput
            type="number"
            min="1"
            max="5"
            formControlName="grade"
          />
        </mat-form-field>

        <mat-form-field appearance="outline" class="full">
          <mat-label>Comment</mat-label>
          <textarea matInput rows="3" formControlName="description"></textarea>
        </mat-form-field>

        <button
          mat-flat-button
          color="accent"
          type="submit"
          [disabled]="reviewing() || loading() || trainerLoading()"
        >
          {{ reviewing() ? "Submitting…" : "Submit" }}
        </button>
      </form>
    </section>

    <mat-divider class="sep"></mat-divider>

    <!-- RECEIVED FEEDBACKS -->
    <section class="section">
      <h3>Received feedbacks</h3>

      <ng-container *ngIf="gradeRows?.length; else noGrades">
        <mat-list>
          <mat-list-item *ngFor="let g of gradeRows">
            <div matListItemTitle>
              <strong>{{ g.subjectName }}</strong>
              &nbsp;•&nbsp;
              <span
                >Grade: <b>{{ g.grade }}</b></span
              >
            </div>
            <div matListItemLine>
              by {{ g.trainerName }} — {{ g.createdAt | date : "mediumDate" }}
            </div>
            <div matListItemLine *ngIf="g.description">
              “{{ g.description }}”
            </div>
          </mat-list-item>
        </mat-list>
      </ng-container>

      <ng-template #noGrades>
        <p>No feedback received yet.</p>
      </ng-template>
    </section>
  </mat-card>
</div>
